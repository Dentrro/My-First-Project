<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Platformer - 100 Levels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        #gameCanvas {
            display: block;
            border: 4px solid #333;
        }

        .ui-button {
            position: absolute;
            background: rgba(255,255,255,0.5);
            border: 3px solid #333;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 10;
        }

        .ui-button:hover {
            background: white;
            transform: scale(1.05);
        }

        #settingsBtn {
            top: 10px;
            left: 10px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #restartBtn {
            top: 10px;
            left: 120px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #helpBtn {
            top: 70px;
            left: 10px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #shopBtn {
            top: 10px;
            right: 10px;
            padding: 10px 20px;
        }

        #editorBtn {
            bottom: 10px;
            left: 10px;
            padding: 10px 20px;
        }

        #levelCodeBtn {
            bottom: 10px;
            right: 10px;
            padding: 10px 20px;
        }

        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 4px solid #333;
            border-radius: 12px;
            padding: 30px;
            z-index: 100;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 99;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        .music-option, .shop-item, .color-option, .skin-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .music-option:hover, .shop-item:hover, .color-option:hover, .skin-option:hover {
            background: #f0f0f0;
            border-color: #667eea;
        }

        .music-option.active, .color-option.active, .skin-option.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-item button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .shop-item button:hover {
            background: #5568d3;
        }

        .shop-item button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #fpsDisplay {
            position: absolute;
            top: 10px;
            left: 70px;
            background: rgba(255,255,255,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            border: 3px solid #333;
            font-weight: bold;
            font-size: 14px;
            z-index: 10;
            display: none;
        }

        #levelDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.5);
            padding: 10px 20px;
            border-radius: 8px;
            border: 3px solid #333;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
        }

        #coinDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(80px);
            background: rgba(255,215,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            border: 3px solid #333;
            font-weight: bold;
            font-size: 18px;
            z-index: 10;
        }

        #menuBtn {
            top: 10px;
            left: 160px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #advancementsBtn {
            top: 70px;
            left: 70px;
            padding: 10px 20px;
        }

        .advancement-notification {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            border: 3px solid #2980b9;
            font-weight: bold;
            font-size: 18px;
            z-index: 200;
            display: none;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .advancement-notification h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .advancement-item {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .advancement-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }

        .advancement-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .advancement-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .advancement-progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 8px;
        }

        .advancement-progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        input[type="range"] {
            padding: 0;
        }

        button.primary {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        button.primary:hover {
            background: #5568d3;
        }

        #editorCanvas {
            border: 2px solid #333;
            margin: 10px 0;
            cursor: crosshair;
        }

        .editor-tools {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .editor-tool {
            padding: 8px 16px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            background: white;
        }

        .editor-tool.active {
            background: #667eea;
            color: white;
        }

        .keybind-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .keybind-item button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 100px;
        }

        .keybind-item button:hover {
            background: #5568d3;
        }

        .keybind-item button.rebinding {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .help-section {
            margin: 20px 0;
        }

        .help-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .help-section p, .help-section ul {
            margin: 5px 0;
            line-height: 1.6;
        }

        .help-section ul {
            list-style-position: inside;
        }

        .death-screen {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.95);
            border: 5px solid #c0392b;
            border-radius: 20px;
            padding: 40px;
            z-index: 150;
            text-align: center;
            color: white;
        }

        .death-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .death-screen button {
            padding: 15px 30px;
            font-size: 20px;
            background: white;
            color: #e74c3c;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
        }

        .death-screen button:hover {
            background: #f0f0f0;
        }

        .start-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            border: 5px solid #333;
            border-radius: 20px;
            padding: 50px;
            z-index: 200;
            text-align: center;
        }

        .start-menu h1 {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 30px;
        }

        .start-menu button {
            padding: 15px 40px;
            font-size: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            min-width: 200px;
        }

        .start-menu button:hover {
            background: #5568d3;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .slider-value {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: bold;
        }

        .color-swatch {
            width: 30px;
            height: 30px;
            display: inline-block;
            border-radius: 5px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .skin-preview {
            width: 40px;
            height: 40px;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="levelDisplay" style="display:none;">Level: 1 / 100</div>
        <div id="coinDisplay" style="display:none;">ü™ô Coins: 0</div>
        <div id="fpsDisplay" style="display:none;">FPS: 60</div>

        <button class="ui-button" id="settingsBtn" style="display:none;">‚öôÔ∏è</button>
        <button class="ui-button" id="restartBtn" style="display:none;">üîÑ</button>
        <button class="ui-button" id="menuBtn" style="display:none;">üè†</button>
        <button class="ui-button" id="helpBtn" style="display:none;">‚ùì</button>
        <button class="ui-button" id="advancementsBtn" style="display:none;">üèÜ Achievements</button>
        <button class="ui-button" id="shopBtn" style="display:none;">Shop</button>
        <button class="ui-button" id="editorBtn" style="display:none;">Level Editor</button>
        <button class="ui-button" id="levelCodeBtn" style="display:none;">Enter Level Code</button>

        <!-- Advancement Notification -->
        <div class="advancement-notification" id="advancementNotification">
            <h3>üèÜ Achievement Unlocked!</h3>
            <p id="advancementText"></p>
        </div>

        <!-- Coin reminder when trying to finish without all coins -->
        <div class="advancement-notification" id="coinReminder" style="background: rgba(231, 76, 60, 0.95); border-color: #c0392b; display:none; z-index:210;">
            <h3>Collect all coins first!</h3>
        </div>

        <!-- Advancements Modal -->
        <div class="modal" id="advancementsModal">
            <span class="close-btn" onclick="closeModal('advancementsModal')">&times;</span>
            <h2>Advancements</h2>
            <div id="advancementsList">
                <!-- Many achievements -->
                <div class="advancement-item" id="adv-level5"><h4>Rookie Runner</h4><p>Complete level 5.</p></div>
                <div class="advancement-item" id="adv-level10"><h4>Getting Good</h4><p>Complete level 10.</p></div>
                <div class="advancement-item" id="adv-collector"><h4>Coin Collector</h4><p>Collect 100 coins total.</p></div>
                <div class="advancement-item" id="adv-speedrun"><h4>Speedrun</h4><p>Finish a level in under 10 seconds.</p></div>
                <div class="advancement-item" id="adv-shopper"><h4>Shopaholic</h4><p>Buy 10 items from the shop.</p></div>
                <div class="advancement-item" id="adv-custom"><h4>Creator</h4><p>Save a custom level.</p></div>
                <div class="advancement-item" id="adv-master"><h4>Master</h4><p>Complete all 100 levels.</p></div>
            </div>
        </div>

        <!-- Start Menu -->
        <div class="start-menu" id="startMenu">
            <h1>üéÆ Epic Platformer</h1>
            <p style="font-size: 18px; margin-bottom: 30px;">100 Levels of Adventure!</p>
            <button onclick="startGame()">Start Game</button>
            <button onclick="openModalFromMenu('helpModal')">‚ùì How to Play</button>
            <button onclick="openModalFromMenu('settingsModal')">‚öôÔ∏è Settings</button>
            <button onclick="openAdvancementsFromMenu()">üèÜ Advancements</button>
        </div>

        <!-- Death Screen -->
        <div class="death-screen" id="deathScreen">
            <h1>üíÄ You Died!</h1>
            <p style="font-size: 24px; margin-bottom: 20px;">Don't give up!</p>
            <button onclick="respawn()">Try Again</button>
            <button onclick="backToMenu()">Main Menu</button>
        </div>

        <div class="modal-overlay" id="modalOverlay"></div>

        <!-- Help Modal -->
        <div class="modal" id="helpModal">
            <span class="close-btn" onclick="closeModal('helpModal')">&times;</span>
            <h2>How to Play</h2>

            <div class="help-section">
                <h3>üéÆ Controls</h3>
                <ul>
                    <li><strong>Move Left:</strong> <span id="helpLeftKey">Arrow Left</span></li>
                    <li><strong>Move Right:</strong> <span id="helpRightKey">Arrow Right</span></li>
                    <li><strong>Jump:</strong> <span id="helpJumpKey">Arrow Up</span></li>
                    <li><strong>Crouch/Shrink:</strong> <span id="helpCrouchKey">Arrow Down</span></li>
                </ul>
                <p><em>You can rebind keys in the Settings menu!</em></p>
            </div>

            <div class="help-section">
                <h3>üéØ Objective</h3>
                <p>Reach the right side of the screen to advance to the next level. Complete all 100 levels!</p>
            </div>

            <div class="help-section">
                <h3>ü™ô Coins & Shop</h3>
                <p>Collect coins throughout levels to buy power-ups in the Shop:</p>
                <ul>
                    <li><strong>Speed Boost:</strong> Move faster temporarily</li>
                    <li><strong>Invisibility:</strong> Enemies can't see you</li>
                    <li><strong>Double Jump:</strong> Jump twice in the air</li>
                    <li><strong>Shield:</strong> Survive one hit from enemies or spikes</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>‚ö†Ô∏è Hazards</h3>
                <ul>
                    <li><strong>Red Spikes:</strong> Touch them and you restart the level</li>
                    <li><strong>Red Enemies:</strong> They pathfind towards you - avoid them!</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>üõ†Ô∏è Level Editor</h3>
                <p>Create custom levels and share them with friends using level codes!</p>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <span class="close-btn" onclick="closeModal('settingsModal')">&times;</span>
            <h2>Settings</h2>

            <h3 style="margin-top: 20px;">Music & Volume</h3>
            <div class="slider-container">
                <label>Music Volume: <span class="slider-value" id="volumeValue">50%</span></label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="updateVolume(this.value)">
            </div>

            <div class="music-option active" data-music="adventure">
                üéµ Adventure Theme
            </div>
            <div class="music-option" data-music="electronic">
                üéµ Electronic Beats
            </div>
            <div class="music-option" data-music="retro">
                üéµ Retro Chiptune
            </div>
            <div class="music-option" data-music="calm">
                üéµ Calm Melody
            </div>
            <div class="music-option" data-music="epic">
                üéµ Epic Orchestra
            </div>
            <div class="music-option" data-music="jazz">
                üéµ Jazz Fusion
            </div>
            <div class="music-option" data-music="rock">
                üéµ Rock Theme
            </div>

            <h3 style="margin-top: 30px;">Background Color</h3>
            <div class="color-option active" data-color="#87CEEB">
                <span class="color-swatch" style="background: #87CEEB;"></span>
                Sky Blue (Default)
            </div>
            <div class="color-option" data-color="#FFE4E1">
                <span class="color-swatch" style="background: #FFE4E1;"></span>
                Misty Rose
            </div>
            <div class="color-option" data-color="#E0F7E0">
                <span class="color-swatch" style="background: #E0F7E0;"></span>
                Mint Green
            </div>
            <div class="color-option" data-color="#2C3E50">
                <span class="color-swatch" style="background: #2C3E50;"></span>
                Dark Mode
            </div>
            <div class="color-option" data-color="#FFF5E6">
                <span class="color-swatch" style="background: #FFF5E6;"></span>
                Cream
            </div>

            <h3 style="margin-top: 30px;">Website Background</h3>
            <div class="color-option active" data-bg="gradient">
                <span class="color-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                Gradient (Default)
            </div>
            <div class="color-option" data-bg="solid-blue">
                <span class="color-swatch" style="background: #667eea;"></span>
                Solid Blue
            </div>
            <div class="color-option" data-bg="solid-dark">
                <span class="color-swatch" style="background: #2c3e50;"></span>
                Dark Mode
            </div>
            <div class="color-option" data-bg="solid-light">
                <span class="color-swatch" style="background: #ecf0f1;"></span>
                Light Gray
            </div>
            <div class="skin-option active" data-skin="purple">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview1"></canvas>
                Purple Square (Default)
            </div>
            <div class="skin-option" data-skin="red">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview2"></canvas>
                Red Cube
            </div>
            <div class="skin-option" data-skin="blue">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview3"></canvas>
                Blue Hero
            </div>
            <div class="skin-option" data-skin="green">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview4"></canvas>
                Green Slime
            </div>
            <div class="skin-option" data-skin="gold">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview5"></canvas>
                Golden Star
            </div>
            <div class="skin-option" data-skin="ninja">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview6"></canvas>
                Ninja
            </div>
            <div class="skin-option" data-skin="robot">
                <canvas class="skin-preview" width="40" height="40" id="skinPreview7"></canvas>
                Robot
            </div>
            

            <h3 style="margin-top: 30px;">Key Bindings</h3>
            <div class="keybind-item">
                <div>
                    <strong>Move Left</strong>
                </div>
                <button onclick="startRebinding('left')" id="leftKeyBtn">Arrow Left</button>
            </div>
            <div class="keybind-item">
                <div>
                    <strong>Move Right</strong>
                </div>
                <button onclick="startRebinding('right')" id="rightKeyBtn">Arrow Right</button>
            </div>
            <div class="keybind-item">
                <div>
                    <strong>Jump</strong>
                </div>
                <button onclick="startRebinding('jump')" id="jumpKeyBtn">Arrow Up</button>
            </div>
            <div class="keybind-item">
                <div>
                    <strong>Crouch/Shrink</strong>
                </div>
                <button onclick="startRebinding('crouch')" id="crouchKeyBtn">Arrow Down</button>
            </div>
        </div>

        <!-- Shop Modal -->
        <div class="modal" id="shopModal">
            <span class="close-btn" onclick="closeModal('shopModal')">&times;</span>
            <h2>Shop - Power-ups</h2>
            <div class="shop-item">
                <div>
                    <strong>Speed Boost</strong><br>
                    <small>Move faster for 10 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 10 coins</span>
                </div>
                <button onclick="buyItem('speed', 10)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Invisibility</strong><br>
                    <small>Enemies can't see you for 8 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 15 coins</span>
                </div>
                <button onclick="buyItem('invisibility', 15)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Double Jump</strong><br>
                    <small>Jump twice for 15 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 12 coins</span>
                </div>
                <button onclick="buyItem('doubleJump', 12)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Shield</strong><br>
                    <small>Survive one hit for 20 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 20 coins</span>
                </div>
                <button onclick="buyItem('shield', 20)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Super Jump</strong><br>
                    <small>Jump 2x higher for 12 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 18 coins</span>
                </div>
                <button onclick="buyItem('superJump', 18)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Coin Magnet</strong><br>
                    <small>Auto-collect nearby coins for 15 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 25 coins</span>
                </div>
                <button onclick="buyItem('coinMagnet', 25)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Slow Motion</strong><br>
                    <small>Slow down time for 10 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 30 coins</span>
                </div>
                <button onclick="buyItem('slowMotion', 30)">Buy</button>
            </div>
            <div class="shop-item">
                <div>
                    <strong>Ghost Mode</strong><br>
                    <small>Walk through platforms for 8 seconds</small><br>
                    <span style="color: gold;">üí∞ Cost: 22 coins</span>
                </div>
                <button onclick="buyItem('ghostMode', 22)">Buy</button>
            </div>
        </div>

        <!-- Advancements Modal -->
        <div class="modal" id="advancementsModal">
            <span class="close-btn" onclick="closeModal('advancementsModal')">&times;</span>
            <h2>üèÜ Achievements</h2>
            <div id="advancementsList"></div>
        </div>

        <!-- Level Code Modal -->
        <div class="modal" id="levelCodeModal">
            <span class="close-btn" onclick="closeModal('levelCodeModal')">&times;</span>
            <h2>Enter Level Code</h2>
            <p>Paste a level code to play custom levels!</p>
            <textarea id="levelCodeInput" rows="4" placeholder="Paste level code here..."></textarea>
            <button class="primary" onclick="loadLevelFromCode()">Load Level</button>
        </div>

        <!-- Level Editor Modal -->
        <div class="modal" id="editorModal" style="max-width: 850px;">
            <span class="close-btn" onclick="closeModal('editorModal')">&times;</span>
            <h2>Level Editor</h2>
            <p><em>Click and drag to create platforms. Grid snapping enabled!</em></p>
            <div class="editor-tools">
                <div class="editor-tool active" data-tool="platform">Platform</div>
                <div class="editor-tool" data-tool="spike">Spike</div>
                <div class="editor-tool" data-tool="enemy">Enemy</div>
                <div class="editor-tool" data-tool="coin">Coin</div>
                <div class="editor-tool" data-tool="erase">Erase</div>
            </div>
            <canvas id="editorCanvas" width="800" height="400"></canvas>
            <button class="primary" onclick="saveCustomLevel()">Save & Get Code</button>
            <textarea id="levelCodeOutput" rows="3" placeholder="Your level code will appear here..." readonly></textarea>
            <button class="primary" onclick="testCustomLevel()">Test Level</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Grid size for snapping
        const GRID_SIZE = 20;

        // Game State
        const game = {
            currentLevel: 1,
            coins: 0,
            totalCoinsCollected: 0,
            powerups: {},
            music: 'adventure',
            customLevel: null,
            paused: false,
            started: false,
            bgColor: '#87CEEB',
            playerSkin: 'purple',
            volume: 0.5,
            coinAnimationOffset: 0,
            fps: 60,
            frameCount: 0,
            lastTime: 0,
            bodyBg: 'gradient',
            advancements: {},
            totalJumps: 0,
            totalDeaths: 0,
            highestLevel: 1,
            powerupsBought: 0,
            enemiesAvoided: 0,
            totalCrouches: 0,
            usedEditor: false,
            playedCustom: false,
            musicTracksPlayed: 0,
            unlockedSkins: 1,
            musicPlayed: new Set(),
            skinsTried: new Set()
        };

        // Define all advancements
        const advancementsList = [
            { id: 'first_steps', name: 'First Steps', description: 'Complete level 1', icon: 'üö∂', check: () => game.currentLevel >= 2 },
            { id: 'coin_collector', name: 'Coin Collector', description: 'Collect 50 coins', icon: 'ü™ô', progress: () => game.totalCoinsCollected, max: 50 },
            { id: 'coin_hoarder', name: 'Coin Hoarder', description: 'Collect 200 coins', icon: 'üí∞', progress: () => game.totalCoinsCollected, max: 200 },
            { id: 'coin_master', name: 'Coin Master', description: 'Collect 500 coins', icon: 'üëë', progress: () => game.totalCoinsCollected, max: 500 },
            { id: 'level_10', name: 'Getting Started', description: 'Reach level 10', icon: '‚≠ê', check: () => game.highestLevel >= 10 },
            { id: 'level_25', name: 'Quarter Way', description: 'Reach level 25', icon: 'üåü', check: () => game.highestLevel >= 25 },
            { id: 'level_50', name: 'Halfway There', description: 'Reach level 50', icon: '‚ú®', check: () => game.highestLevel >= 50 },
            { id: 'level_75', name: 'Almost Done', description: 'Reach level 75', icon: 'üí´', check: () => game.highestLevel >= 75 },
            { id: 'level_100', name: 'Century', description: 'Reach level 100', icon: 'üéØ', check: () => game.highestLevel >= 100 },
            { id: 'jumper', name: 'Jumper', description: 'Jump 100 times', icon: '‚¨ÜÔ∏è', progress: () => game.totalJumps, max: 100 },
            { id: 'super_jumper', name: 'Super Jumper', description: 'Jump 500 times', icon: 'ü¶ò', progress: () => game.totalJumps, max: 500 },
            { id: 'survivor', name: 'Survivor', description: 'Die 10 times (we all learn!)', icon: 'üíÄ', progress: () => game.totalDeaths, max: 10 },
            { id: 'persistent', name: 'Persistent', description: 'Die 50 times', icon: 'üî•', progress: () => game.totalDeaths, max: 50 },
            { id: 'shopaholic', name: 'Shopaholic', description: 'Buy 10 power-ups', icon: 'üõí', progress: () => game.powerupsBought, max: 10 },
            { id: 'power_user', name: 'Power User', description: 'Buy 25 power-ups', icon: '‚ö°', progress: () => game.powerupsBought, max: 25 },
            { id: 'customizer', name: 'Customizer', description: 'Change your skin', icon: 'üé®', check: () => game.playerSkin !== 'purple' },
            { id: 'dj', name: 'DJ', description: 'Change the music', icon: 'üéµ', check: () => game.music !== 'adventure' },
            { id: 'speed_demon', name: 'Speed Demon', description: 'Complete a level in under 5 seconds', icon: 'üèÉ', check: () => false }, // Tracked separately
            { id: 'no_damage', name: 'Untouchable', description: 'Complete 5 levels without dying', icon: 'üõ°Ô∏è', check: () => false }, // Tracked separately
            { id: 'perfectionist', name: 'Perfectionist', description: 'Collect all coins in 10 different levels', icon: 'üíØ', progress: () => game.perfectLevels || 0, max: 10 },
            { id: 'crouch_master', name: 'Crouch Master', description: 'Crouch 50 times', icon: 'üßò', progress: () => game.totalCrouches || 0, max: 50 },
            { id: 'level_editor', name: 'Level Creator', description: 'Use the level editor', icon: 'üõ†Ô∏è', check: () => game.usedEditor || false },
            { id: 'custom_player', name: 'Custom Player', description: 'Play a custom level', icon: 'üéÆ', check: () => game.playedCustom || false },
            { id: 'music_lover', name: 'Music Lover', description: 'Listen to all music tracks', icon: 'üéº', check: () => game.musicTracksPlayed >= 3 },
            { id: 'skin_collector', name: 'Skin Collector', description: 'Unlock all skins', icon: 'üëï', check: () => game.unlockedSkins >= 5 }
        ];

        // Initialize advancements
        advancementsList.forEach(adv => {
            game.advancements[adv.id] = false;
        });

        // Audio context for music
        let audioContext = null;
        let musicGainNode = null;
        let currentOscillators = [];
        let musicLoopTimeout = null;

        // Key bindings
        const keyBindings = {
            left: ['ArrowLeft'],
            right: ['ArrowRight'],
            jump: ['ArrowUp'],
            crouch: ['ArrowDown']
        };

        // Player
        const player = {
            x: 50,
            y: 400,
            width: 30,
            height: 30,
            baseWidth: 30,
            baseHeight: 30,
            vx: 0,
            vy: 0,
            speed: 5,
            jumpPower: 12,
            onGround: false,
            hasDoubleJump: false,
            jumpCount: 0,
            isCrouching: false,
            walkFrame: 0,
            walkAnimationSpeed: 0.2
        };

        // Seeded random number generator for consistent levels
        function seededRandom(seed) {
            const x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // Create a seeded random generator for a level
        function createLevelRNG(levelNum) {
            let seed = levelNum * 9999;
            return function() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };
        }

        // Physics
        const gravity = 0.5;
        const friction = 0.8;

        // Input
        const keys = {};

        // Snap to grid helper
        function snapToGrid(value) {
            return Math.round(value / GRID_SIZE) * GRID_SIZE;
        }

        // Level generation with seeded random for consistency
        function generateLevel(levelNum) {
            const rng = createLevelRNG(levelNum);
            const difficulty = Math.min(levelNum / 20, 5);
            const platforms = [];
            const spikes = [];
            const enemies = [];
            const coins = [];

            // Ground
            platforms.push({x: 0, y: 560, width: 800, height: 40});

            // Generate platforms with grid snapping and seeded random
            const numPlatforms = Math.floor(4 + difficulty * 1.5);
            for (let i = 0; i < numPlatforms; i++) {
                const x = snapToGrid(120 + (i * (550 / numPlatforms)));
                // Lower platforms slightly for playability
                const y = snapToGrid(540 - rng() * 180);
                const width = snapToGrid(Math.max(100, 140 - difficulty * 8));
                platforms.push({x, y, width, height: 20});
            }

            // Add spikes with seeded random
            const numSpikes = Math.floor(difficulty * 0.7);
            for (let i = 0; i < numSpikes; i++) {
                const platform = platforms[Math.floor(rng() * platforms.length)];
                const spikeX = snapToGrid(platform.x + rng() * (platform.width - 40));
                spikes.push({
                    x: spikeX,
                    y: platform.y - 20,
                    width: 30,
                    height: 20
                });
            }

            // Add enemies with seeded random
            const numEnemies = Math.floor(difficulty / 3);
            for (let i = 0; i < numEnemies; i++) {
                if (platforms[i + 2]) {
                    const platform = platforms[i + 2];
                    enemies.push({
                        x: platform.x + platform.width / 2,
                        y: platform.y - 30,
                        width: 25,
                        height: 25,
                        vx: 0,
                        vy: 0,
                        onGround: false,
                        platform: platform,
                        minX: platform.x,
                        maxX: platform.x + platform.width - 25
                    });
                }
            }

            // Add coins with seeded random
            const numCoins = Math.floor(5 + difficulty);
            for (let i = 0; i < numCoins; i++) {
                if (platforms[i + 1]) {
                    const platform = platforms[i + 1];
                    const coinX = snapToGrid(platform.x + rng() * platform.width);
                    coins.push({
                        x: coinX,
                        y: platform.y - 60 - rng() * 40,
                        width: 24,
                        height: 24,
                        collected: false
                    });
                }
            }

            return {platforms, spikes, enemies, coins, totalCoins: numCoins};
        }

        let currentLevelData = generateLevel(1);

        // Player skin rendering with walking animation
        const playerSkins = {
            purple: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                ctx.fillStyle = '#9b59b6';
                ctx.fillRect(x, y + bounce, w, h - bounce);
                drawEyes(x, y + bounce, w, h - bounce, 'white', 'black');
            },
            red: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x, y + bounce, w, h - bounce);
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y + bounce, w, h - bounce);
                drawEyes(x, y + bounce, w, h - bounce, 'yellow', 'black');
            },
            blue: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, y + bounce, w, h - bounce);
                ctx.fillStyle = '#2980b9';
                ctx.fillRect(x + w/4, y + bounce, w/2, 3);
                drawEyes(x, y + bounce, w, h - bounce, 'white', '#2c3e50');
            },
            green: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                ctx.fillStyle = '#2ecc71';
                ctx.beginPath();
                ctx.arc(x + w/2, y + h/2 + bounce, w/2, 0, Math.PI * 2);
                ctx.fill();
                drawEyes(x, y + bounce, w, h - bounce, 'white', 'black');
            },
            gold: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                ctx.fillStyle = '#f1c40f';
                ctx.beginPath();
                for(let i = 0; i < 5; i++) {
                    const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                    const px = x + w/2 + Math.cos(angle) * w/2;
                    const py = y + h/2 + bounce + Math.sin(angle) * (h/2 - bounce/2);
                    if(i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                    const angle2 = angle + Math.PI / 5;
                    const px2 = x + w/2 + Math.cos(angle2) * w/4;
                    const py2 = y + h/2 + bounce + Math.sin(angle2) * (h/4 - bounce/4);
                    ctx.lineTo(px2, py2);
                }
                ctx.closePath();
                ctx.fill();
                drawEyes(x, y + bounce, w, h - bounce, 'black', 'white');
            },
            ninja: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 2;
                // Body
                ctx.fillStyle = '#34495e';
                ctx.fillRect(x, y + bounce, w, h - bounce);
                // Headband
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x, y + bounce + 5, w, 4);
                // Eyes (ninja slits)
                ctx.fillStyle = 'white';
                ctx.fillRect(x + 8, y + bounce + 12, 5, 2);
                ctx.fillRect(x + 17, y + bounce + 12, 5, 2);
            },
            robot: (x, y, w, h, frame) => {
                const bounce = Math.sin(frame) * 1.5;
                // Body
                ctx.fillStyle = '#95a5a6';
                ctx.fillRect(x, y + bounce, w, h - bounce);
                // Antenna
                ctx.strokeStyle = '#7f8c8d';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x + w/2, y + bounce);
                ctx.lineTo(x + w/2, y + bounce - 5);
                ctx.stroke();
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(x + w/2, y + bounce - 5, 2, 0, Math.PI * 2);
                ctx.fill();
                // Visor
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x + 5, y + bounce + 8, w - 10, 6);
            },
            }
        };

        // Draw eyes with smaller size
        function drawEyes(x, y, w, h, eyeColor, pupilColor) {
            const eyeSize = 5; // Made smaller
            const pupilSize = 2.5; // Made smaller
            const eyeY = y + 8;

            ctx.fillStyle = eyeColor;
            ctx.beginPath();
            ctx.arc(x + 10, eyeY, eyeSize, 0, Math.PI * 2);
            ctx.arc(x + 20, eyeY, eyeSize, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = pupilColor;
            ctx.beginPath();
            ctx.arc(x + 10, eyeY, pupilSize, 0, Math.PI * 2);
            ctx.arc(x + 20, eyeY, pupilSize, 0, Math.PI * 2);
            ctx.fill();
        }

        // Draw player with animation
        function drawPlayer() {
            const alpha = game.powerups.invisibility ? 0.3 : 1;
            ctx.globalAlpha = alpha;

            // Update walk animation
            if (Math.abs(player.vx) > 0.1 && player.onGround) {
                player.walkFrame += player.walkAnimationSpeed;
            } else {
                player.walkFrame = 0;
            }

            // Draw based on selected skin with animation frame
            playerSkins[game.playerSkin](player.x, player.y, player.width, player.height, player.walkFrame);

            // Shield effect
            if (game.powerups.shield) {
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x + player.width/2, player.y + player.height/2,
                       player.width/2 + 5, 0, Math.PI * 2);
                ctx.stroke();
            }

            ctx.globalAlpha = 1;
        }

        // Draw level
        function drawLevel(levelData) {
            // Platforms
            ctx.fillStyle = '#2c3e50';
            levelData.platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                ctx.strokeStyle = '#34495e';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            });

            // Spikes
            ctx.fillStyle = '#e74c3c';
            levelData.spikes.forEach(spike => {
                ctx.beginPath();
                ctx.moveTo(spike.x, spike.y + spike.height);
                ctx.lineTo(spike.x + spike.width / 2, spike.y);
                ctx.lineTo(spike.x + spike.width, spike.y + spike.height);
                ctx.closePath();
                ctx.fill();
            });

            // Enemies
            levelData.enemies.forEach(enemy => {
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

                // Evil eyes
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(enemy.x + 8, enemy.y + 8, 3, 0, Math.PI * 2);
                ctx.arc(enemy.x + 17, enemy.y + 8, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // Animated coins
            game.coinAnimationOffset = (game.coinAnimationOffset + 0.1) % (Math.PI * 2);
            levelData.coins.forEach(coin => {
                if (!coin.collected) {
                    // Sparkle effect
                    ctx.save();
                    ctx.translate(coin.x + coin.width/2, coin.y + coin.height/2);

                    // Pulsing glow
                    const pulse = Math.sin(game.coinAnimationOffset) * 0.15 + 1;
                    ctx.scale(pulse, pulse);

                    // Outer glow
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, coin.width/2 * 1.3);
                    gradient.addColorStop(0, '#f1c40f');
                    gradient.addColorStop(0.7, '#f39c12');
                    gradient.addColorStop(1, 'rgba(243,156,18,0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, coin.width/2 * 1.3, 0, Math.PI * 2);
                    ctx.fill();

                    // Main coin
                    ctx.fillStyle = '#f1c40f';
                    ctx.beginPath();
                    ctx.arc(0, 0, coin.width/2, 0, Math.PI * 2);
                    ctx.fill();

                    // Inner shine
                    ctx.fillStyle = '#f39c12';
                    ctx.beginPath();
                    ctx.arc(0, 0, coin.width/3, 0, Math.PI * 2);
                    ctx.fill();

                    // Highlight
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath();
                    ctx.arc(-3, -3, coin.width/6, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.restore();
                }
            });
        }

        // Collision detection
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Improved enemy pathfinding - prevents falling off platforms
        function updateEnemies(levelData) {
            if (game.powerups.invisibility) return;

            levelData.enemies.forEach(enemy => {
                // Apply gravity
                enemy.vy += gravity;
                enemy.y += enemy.vy;

                // Simple AI - stay on platform
                const dx = player.x - enemy.x;
                const distance = Math.abs(dx);

                if (distance < 300 && !game.powerups.invisibility) {
                    const speed = 1.5;
                    if (dx > 0 && enemy.x < enemy.maxX) {
                        enemy.vx = speed;
                    } else if (dx < 0 && enemy.x > enemy.minX) {
                        enemy.vx = -speed;
                    } else {
                        enemy.vx *= friction;
                    }
                } else {
                    enemy.vx *= friction;
                }

                // Constrain to platform boundaries
                enemy.x += enemy.vx;
                if (enemy.x < enemy.minX) {
                    enemy.x = enemy.minX;
                    enemy.vx = 0;
                }
                if (enemy.x > enemy.maxX) {
                    enemy.x = enemy.maxX;
                    enemy.vx = 0;
                }

                // Platform collision
                enemy.onGround = false;
                levelData.platforms.forEach(platform => {
                    if (checkCollision(enemy, platform)) {
                        if (enemy.vy > 0 && enemy.y + enemy.height - enemy.vy < platform.y + 5) {
                            enemy.y = platform.y - enemy.height;
                            enemy.vy = 0;
                            enemy.onGround = true;
                        }
                    }
                });
            });
        }

        // Helper function to check if any bound key is pressed
        function isKeyPressed(action) {
            return keyBindings[action].some(key => keys[key]);
        }

        // Update player
        function updatePlayer(levelData) {
            // Crouch/Shrink handling (only top shrinks, keep width constant)
            if (isKeyPressed('crouch') && player.onGround) {
                if (!player.isCrouching) {
                    // Store the bottom position before shrinking
                    const bottomY = player.y + player.height;
                    player.isCrouching = true;
                    player.width = player.baseWidth; // keep full width
                    player.height = player.baseHeight * 0.6; // only shrink height
                    // Keep the bottom position the same so player doesn't fall through
                    player.y = bottomY - player.height;
                    game.totalCrouches++;
                }
            } else {
                if (player.isCrouching) {
                    const bottomY = player.y + player.height;
                    const testPlayer = {
                        x: player.x,
                        y: bottomY - player.baseHeight,
                        width: player.baseWidth,
                        height: player.baseHeight
                    };

                    let canStand = true;
                    levelData.platforms.forEach(platform => {
                        if (checkCollision(testPlayer, platform)) {
                            canStand = false;
                        }
                    });

                    if (canStand) {
                        player.y = bottomY - player.baseHeight;
                        player.width = player.baseWidth;
                        player.height = player.baseHeight;
                        player.isCrouching = false;
                    }
                } else {
                    player.width = player.baseWidth;
                    player.height = player.baseHeight;
                }
            }

            // Apply powerups
            const speed = game.powerups.speed ? player.speed * 1.5 : player.speed;
            const moveSpeed = player.isCrouching ? speed * 0.5 : speed;

            // Horizontal movement
            if (isKeyPressed('left')) {
                player.vx = -moveSpeed;
            } else if (isKeyPressed('right')) {
                player.vx = moveSpeed;
            } else {
                player.vx *= friction;
            }

            // Jumping with super jump support
            if (isKeyPressed('jump') && !keys.jumpPressed && !player.isCrouching) {
                const jumpPower = game.powerups.superJump ? player.jumpPower * 2 : player.jumpPower;
                if (player.onGround) {
                    player.vy = -jumpPower;
                    player.jumpCount = 1;
                    game.totalJumps++;
                    checkAdvancements();
                } else if (game.powerups.doubleJump && player.jumpCount < 2) {
                    player.vy = -jumpPower;
                    player.jumpCount++;
                    game.totalJumps++;
                    checkAdvancements();
                }
                keys.jumpPressed = true;
            }

            if (!isKeyPressed('jump')) {
                keys.jumpPressed = false;
            }

            // Apply gravity
            player.vy += gravity;

            // Update position
            player.x += player.vx;
            player.y += player.vy;

            // Platform collision (skip if ghost mode is active)
            player.onGround = false;
            if (!game.powerups.ghostMode) {
                levelData.platforms.forEach(platform => {
                    if (checkCollision(player, platform)) {
                        if (player.vy > 0 && player.y + player.height - player.vy < platform.y + 5) {
                            player.y = platform.y - player.height;
                            player.vy = 0;
                            player.onGround = true;
                            player.jumpCount = 0;
                        } else if (player.vy < 0 && player.y - player.vy > platform.y + platform.height - 5) {
                            player.y = platform.y + platform.height;
                            player.vy = 0;
                        }

                        if (player.vx > 0 && player.x + player.width - player.vx < platform.x + 5) {
                            player.x = platform.x - player.width;
                            player.vx = 0;
                        } else if (player.vx < 0 && player.x - player.vx > platform.x + platform.width - 5) {
                            player.x = platform.x + platform.width;
                            player.vx = 0;
                        }
                    }
                });
            } else {
                // In ghost mode, still need to detect ground for the bottom of the screen
                player.onGround = false;
            }

            // Coin collection with magnet support
            levelData.coins.forEach(coin => {
                if (!coin.collected) {
                    // Coin magnet effect
                    if (game.powerups.coinMagnet) {
                        const dx = player.x + player.width/2 - (coin.x + coin.width/2);
                        const dy = player.y + player.height/2 - (coin.y + coin.height/2);
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < 150) {
                            coin.x += dx * 0.1;
                            coin.y += dy * 0.1;
                        }
                    }

                    if (checkCollision(player, coin)) {
                        coin.collected = true;
                        game.coins++;
                        game.totalCoinsCollected++;
                        updateUI();
                        checkAdvancements();
                    }
                }
            });

            // Spike collision
            levelData.spikes.forEach(spike => {
                if (checkCollision(player, spike)) {
                    if (game.powerups.shield) {
                        game.powerups.shield = false;
                    } else {
                        showDeathScreen();
                    }
                }
            });

            // Enemy collision
            levelData.enemies.forEach(enemy => {
                if (checkCollision(player, enemy) && !game.powerups.invisibility) {
                    if (game.powerups.shield) {
                        game.powerups.shield = false;
                    } else {
                        showDeathScreen();
                    }
                }
            });

            // Boundary check
            if (player.x < 0) player.x = 0;
            if (player.y > canvas.height) {
                showDeathScreen();
            }

            // Level completion - reach right side with all coins collected
            if (player.x + player.width > canvas.width) {
                const collectedCoins = levelData.coins.filter(c => c.collected).length;
                const totalCoins = levelData.coins.length;

                if (collectedCoins === totalCoins) {
                    nextLevel();
                } else {
                    // Push player back if they haven't collected all coins
                    player.x = canvas.width - player.width - 10;
                    player.vx = 0;

                    // Show a temporary DOM message for 2 seconds
                    showCoinReminder(collectedCoins, totalCoins);
                }
            }
        }

        // Show death screen
        function showDeathScreen() {
            game.paused = true;
            game.totalDeaths++;
            checkAdvancements();
            document.getElementById('deathScreen').style.display = 'block';
        }

        // Respawn
        function respawn() {
            document.getElementById('deathScreen').style.display = 'none';
            game.paused = false;
            resetLevel();
        }

        // Back to menu
        function backToMenu() {
            document.getElementById('deathScreen').style.display = 'none';
            document.getElementById('startMenu').style.display = 'flex';
            game.paused = true;
            game.started = false;
            document.getElementById('settingsBtn').style.display = 'none';
            document.getElementById('helpBtn').style.display = 'none';
            document.getElementById('shopBtn').style.display = 'none';
            document.getElementById('editorBtn').style.display = 'none';
            document.getElementById('levelCodeBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('menuBtn').style.display = 'none';
            document.getElementById('advancementsBtn').style.display = 'none';
            document.getElementById('levelDisplay').style.display = 'none';
            document.getElementById('coinDisplay').style.display = 'none';
            document.getElementById('fpsDisplay').style.display = 'none';
        }

        // Reset level
        function resetLevel() {
            player.x = 50;
            player.y = 400;
            player.vx = 0;
            player.vy = 0;
            player.onGround = false;
            player.width = player.baseWidth;
            player.height = player.baseHeight;
            player.isCrouching = false;

            // Reset level data
            if (game.customLevel) {
                currentLevelData = game.customLevel;
                game.customLevel.coins.forEach(coin => coin.collected = false);
            } else {
                currentLevelData = generateLevel(game.currentLevel);
            }
        }

        // Next level
        function nextLevel() {
            if (game.currentLevel < 100) {
                game.currentLevel++;
                if (game.currentLevel > game.highestLevel) {
                    game.highestLevel = game.currentLevel;
                    checkAdvancements();
                }
                resetLevel();
                updateUI();
            } else {
                alert('Congratulations! You completed all 100 levels!');
                unlockAdvancement('level_100');
                game.currentLevel = 1;
                resetLevel();
                updateUI();
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('levelDisplay').textContent =
                `Level: ${game.currentLevel} / 100`;

            const collectedCoins = currentLevelData.coins.filter(c => c.collected).length;
            const totalCoins = currentLevelData.coins.length;
            document.getElementById('coinDisplay').textContent =
                `ü™ô ${collectedCoins}/${totalCoins} | Total: ${game.coins}`;
        }

        // Start game
        function startGame() {
            document.getElementById('startMenu').style.display = 'none';
            game.started = true;
            game.paused = false;
            document.getElementById('settingsBtn').style.display = 'flex';
            document.getElementById('helpBtn').style.display = 'flex';
            document.getElementById('shopBtn').style.display = 'block';
            document.getElementById('editorBtn').style.display = 'block';
            document.getElementById('levelCodeBtn').style.display = 'block';
            document.getElementById('restartBtn').style.display = 'flex';
            document.getElementById('menuBtn').style.display = 'flex';
            document.getElementById('advancementsBtn').style.display = 'block';
            document.getElementById('levelDisplay').style.display = 'block';
            document.getElementById('coinDisplay').style.display = 'block';
            document.getElementById('fpsDisplay').style.display = 'block';
            initMusic();
        }

        // Game loop
        function gameLoop(timestamp) {
            // Calculate FPS
            game.frameCount++;
            if (timestamp - game.lastTime >= 1000) {
                game.fps = game.frameCount;
                game.frameCount = 0;
                game.lastTime = timestamp;
                document.getElementById('fpsDisplay').textContent = `FPS: ${game.fps}`;
            }

            // Clear canvas with custom background color
            ctx.fillStyle = game.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (game.started && !game.paused) {
                updatePlayer(currentLevelData);
                updateEnemies(currentLevelData);
            }

            if (game.started) {
                drawLevel(currentLevelData);
                drawPlayer();

                // Draw powerup indicators
                let powerupY = 190;
                if (game.powerups.speed) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.fillRect(10, powerupY, 120, 30);
                    ctx.fillStyle = 'black';
                    ctx.font = '14px Arial';
                    ctx.fillText('‚ö° Speed Boost', 15, powerupY + 20);
                    powerupY += 35;
                }
                if (game.powerups.invisibility) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.fillRect(10, powerupY, 120, 30);
                    ctx.fillStyle = 'black';
                    ctx.font = '14px Arial';
                    ctx.fillText('üëª Invisible', 15, powerupY + 20);
                    powerupY += 35;
                }
                if (game.powerups.doubleJump) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.fillRect(10, powerupY, 120, 30);
                    ctx.fillStyle = 'black';
                    ctx.font = '14px Arial';
                    ctx.fillText('‚¨ÜÔ∏è Double Jump', 15, powerupY + 20);
                    powerupY += 35;
                }
                if (game.powerups.shield) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.fillRect(10, powerupY, 120, 30);
                    ctx.fillStyle = 'black';
                    ctx.font = '14px Arial';
                    ctx.fillText('üõ°Ô∏è Shield', 15, powerupY + 20);
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // Music initialization
        function initMusic() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                musicGainNode = audioContext.createGain();
                musicGainNode.connect(audioContext.destination);
                musicGainNode.gain.value = game.volume;
                playMusic(game.music);
            } catch(e) {
                console.log('Web Audio API not supported');
            }
        }

        // Simple music player using oscillators
        function playMusic(musicType) {
            stopMusic();
            if (!audioContext) return;

            const melodies = {
                adventure: [[440, 0.3], [494, 0.3], [523, 0.3], [587, 0.6]],
                electronic: [[523, 0.2], [587, 0.2], [659, 0.2], [698, 0.4]],
                retro: [[330, 0.25], [440, 0.25], [330, 0.25], [440, 0.5]],
                calm: [[392, 0.5], [440, 0.5], [494, 0.5], [523, 1]],
                epic: [[262, 0.4], [330, 0.4], [392, 0.4], [523, 0.8]],
                jazz: [[349, 0.3], [415, 0.3], [466, 0.3], [392, 0.6]],
                rock: [[330, 0.25], [330, 0.25], [392, 0.25], [466, 0.5]]
            };

            const melody = melodies[musicType] || melodies.adventure;
            let time = audioContext.currentTime;

            function playMelody() {
                melody.forEach(([freq, duration]) => {
                    const osc = audioContext.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    osc.connect(musicGainNode);
                    osc.start(time);
                    osc.stop(time + duration);
                    currentOscillators.push(osc);
                    time += duration;
                });
                // Schedule next loop and keep a handle so we can cancel when switching tracks
                musicLoopTimeout = setTimeout(() => {
                    currentOscillators = [];
                    if (game.started) playMelody();
                }, (time - audioContext.currentTime) * 1000);
            }

            playMelody();
        }

        function stopMusic() {
            if (musicLoopTimeout) {
                clearTimeout(musicLoopTimeout);
                musicLoopTimeout = null;
            }
            currentOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            currentOscillators = [];
        }

        function updateVolume(value) {
            game.volume = value / 100;
            document.getElementById('volumeValue').textContent = value + '%';
            if (musicGainNode) {
                musicGainNode.gain.value = game.volume;
            }
        }

        // Input handlers
        window.addEventListener('keydown', (e) => {
            if (rebindingAction && game.paused) {
                e.preventDefault();
                keyBindings[rebindingAction] = [e.key];
                const btnId = rebindingAction + 'KeyBtn';
                const btn = document.getElementById(btnId);
                btn.textContent = formatKeyName(e.key);
                btn.classList.remove('rebinding');
                rebindingAction = null;
                return;
            }

            if (!game.paused) {
                keys[e.key] = true;
            }
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // UI Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
            game.paused = true;
        }

        function openModalFromMenu(modalId) {
            document.getElementById('startMenu').style.display = 'none';
            document.getElementById(modalId).style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            if (game.started) {
                game.paused = false;
            } else {
                // Return to start menu if game hasn't started
                document.getElementById('startMenu').style.display = 'flex';
            }
        }

        // Open advancements from start menu (keeps start menu hidden until closed)
        function openAdvancementsFromMenu() {
            updateAdvancementsList();
            openModalFromMenu('advancementsModal');
        }

        // Show coin reminder for 2 seconds
        let coinReminderTimeout = null;
        function showCoinReminder(collected, total) {
            const div = document.getElementById('coinReminder');
            div.querySelector('h3').textContent = 'Collect all coins first!';
            div.style.display = 'block';
            if (coinReminderTimeout) clearTimeout(coinReminderTimeout);
            coinReminderTimeout = setTimeout(() => {
                div.style.display = 'none';
                coinReminderTimeout = null;
            }, 2000);
        }

        // Advancement functions
        function checkAdvancements() {
            advancementsList.forEach(adv => {
                if (!game.advancements[adv.id]) {
                    let unlocked = false;

                    if (adv.check) {
                        unlocked = adv.check();
                    } else if (adv.progress && adv.max) {
                        unlocked = adv.progress() >= adv.max;
                    }

                    if (unlocked) {
                        unlockAdvancement(adv.id);
                    }
                }
            });
        }

        function unlockAdvancement(advId) {
            if (game.advancements[advId]) return; // Already unlocked

            game.advancements[advId] = true;
            const adv = advancementsList.find(a => a.id === advId);

            if (adv) {
                // Show notification
                const notification = document.getElementById('advancementNotification');
                const text = document.getElementById('advancementText');
                text.textContent = `${adv.icon} ${adv.name}: ${adv.description}`;
                notification.style.display = 'block';

                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            updateAdvancementsList();
        }

        function updateAdvancementsList() {
            const container = document.getElementById('advancementsList');
            container.innerHTML = '';

            advancementsList.forEach(adv => {
                const item = document.createElement('div');
                item.className = 'advancement-item';
                if (game.advancements[adv.id]) {
                    item.classList.add('completed');
                }

                const title = document.createElement('h4');
                title.textContent = `${adv.icon} ${adv.name}`;
                item.appendChild(title);

                const desc = document.createElement('p');
                desc.textContent = adv.description;
                item.appendChild(desc);

                // Progress bar if applicable
                if (adv.progress && adv.max) {
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'advancement-progress';

                    const progressBar = document.createElement('div');
                    progressBar.className = 'advancement-progress-bar';
                    const current = adv.progress();
                    const percentage = Math.min(100, (current / adv.max) * 100);
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = `${current}/${adv.max}`;

                    progressContainer.appendChild(progressBar);
                    item.appendChild(progressContainer);
                }

                container.appendChild(item);
            });
        }

        // Help
        document.getElementById('helpBtn').addEventListener('click', () => {
            updateHelpDisplay();
            openModal('helpModal');
        });

        function updateHelpDisplay() {
            document.getElementById('helpLeftKey').textContent = formatKeyName(keyBindings.left[0]);
            document.getElementById('helpRightKey').textContent = formatKeyName(keyBindings.right[0]);
            document.getElementById('helpJumpKey').textContent = formatKeyName(keyBindings.jump[0]);
            document.getElementById('helpCrouchKey').textContent = formatKeyName(keyBindings.crouch[0]);
        }

        function formatKeyName(key) {
            const keyNames = {
                'ArrowLeft': 'Arrow Left',
                'ArrowRight': 'Arrow Right',
                'ArrowUp': 'Arrow Up',
                'ArrowDown': 'Arrow Down',
                ' ': 'Space'
            };
            return keyNames[key] || key.toUpperCase();
        }

        // Settings
        document.getElementById('settingsBtn').addEventListener('click', () => {
            updateKeyBindingDisplay();
            openModal('settingsModal');
        });

        // Restart
        document.getElementById('restartBtn').addEventListener('click', () => {
            respawn();
        });

        // Menu button
        document.getElementById('menuBtn').addEventListener('click', () => {
            backToMenu();
        });

        // Advancements button
        document.getElementById('advancementsBtn').addEventListener('click', () => {
            updateAdvancementsList();
            openModal('advancementsModal');
        });

        function updateKeyBindingDisplay() {
            document.getElementById('leftKeyBtn').textContent = formatKeyName(keyBindings.left[0]);
            document.getElementById('rightKeyBtn').textContent = formatKeyName(keyBindings.right[0]);
            document.getElementById('jumpKeyBtn').textContent = formatKeyName(keyBindings.jump[0]);
            document.getElementById('crouchKeyBtn').textContent = formatKeyName(keyBindings.crouch[0]);
        }

        // Key rebinding
        let rebindingAction = null;

        function startRebinding(action) {
            rebindingAction = action;
            const btnId = action + 'KeyBtn';
            const btn = document.getElementById(btnId);
            btn.textContent = 'Press any key...';
            btn.classList.add('rebinding');
        }

        // Music selection
        document.querySelectorAll('.music-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.music-option').forEach(o =>
                    o.classList.remove('active'));
                option.classList.add('active');
                game.music = option.dataset.music;
                game.musicPlayed.add(option.dataset.music);
                game.musicTracksPlayed = game.musicPlayed.size;
                if (audioContext) {
                    playMusic(game.music);
                }
                checkAdvancements(); // Check for DJ achievement
            });
        });

        // Background color selection
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(o =>
                    o.classList.remove('active'));
                option.classList.add('active');
                game.bgColor = option.dataset.color;
                canvas.style.background = game.bgColor;
            });
        });

        // Skin selection
        document.querySelectorAll('.skin-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.skin-option').forEach(o =>
                    o.classList.remove('active'));
                option.classList.add('active');
                game.playerSkin = option.dataset.skin;
                game.skinsTried.add(option.dataset.skin);
                game.unlockedSkins = game.skinsTried.size;
                checkAdvancements(); // Check for customizer achievement
            });
        });

        // Website background selection
        document.querySelectorAll('.color-option[data-bg]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.color-option[data-bg]').forEach(o =>
                    o.classList.remove('active'));
                option.classList.add('active');
                game.bodyBg = option.dataset.bg;
                updateBodyBackground();
            });
        });

        // Draw skin previews
        function drawSkinPreviews() {
            const skins = ['purple', 'red', 'blue', 'green', 'gold', 'ninja', 'robot'];
            skins.forEach((skin, index) => {
                const previewCanvas = document.getElementById('skinPreview' + (index + 1));
                if (!previewCanvas) return;
                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.clearRect(0, 0, 40, 40);

                // Temporarily switch context to draw preview
                const oldCtx = ctx;
                const tempCanvas = previewCanvas;
                window.ctx = previewCtx;

                playerSkins[skin](5, 5, 30, 30, 0);

                window.ctx = oldCtx;
            });
        }

        // Update body background
        function updateBodyBackground() {
            const bgOptions = {
                'gradient': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'solid-blue': '#667eea',
                'solid-dark': '#2c3e50',
                'solid-light': '#ecf0f1'
            };
            document.body.style.background = bgOptions[game.bodyBg] || bgOptions.gradient;
        }

        // Shop
        document.getElementById('shopBtn').addEventListener('click', () => {
            openModal('shopModal');
        });

        function buyItem(item, cost) {
            if (game.coins >= cost) {
                game.coins -= cost;
                game.powerups[item] = true;
                game.powerupsBought++;
                updateUI();
                checkAdvancements();

                const durations = {
                    speed: 10000,
                    invisibility: 8000,
                    doubleJump: 15000,
                    shield: 20000,
                    superJump: 12000,
                    coinMagnet: 15000,
                    slowMotion: 10000,
                    ghostMode: 8000
                };

                setTimeout(() => {
                    game.powerups[item] = false;
                }, durations[item]);

                closeModal('shopModal');
            } else {
                alert('Not enough coins!');
            }
        }

        // Level Editor
        document.getElementById('editorBtn').addEventListener('click', () => {
            game.usedEditor = true;
            openModal('editorModal');
            initLevelEditor();
        });

        document.getElementById('levelCodeBtn').addEventListener('click', () => {
            openModal('levelCodeModal');
        });

        function loadLevelFromCode() {
            const code = document.getElementById('levelCodeInput').value.trim();
            if (!code) {
                alert('Please enter a level code!');
                return;
            }

            try {
                const levelData = JSON.parse(atob(code));
                game.customLevel = levelData;
                currentLevelData = levelData;
                game.playedCustom = true;
                resetLevel();
                closeModal('levelCodeModal');
                alert('Custom level loaded!');
            } catch (e) {
                alert('Invalid level code!');
            }
        }

        // Level Editor Implementation with grid snapping
        let editorState = {
            tool: 'platform',
            platforms: [],
            spikes: [],
            enemies: [],
            coins: []
        };

        function initLevelEditor() {
            const editorCanvas = document.getElementById('editorCanvas');
            const editorCtx = editorCanvas.getContext('2d');

            editorState = {
                tool: 'platform',
                platforms: [{x: 0, y: 360, width: 800, height: 40}],
                spikes: [],
                enemies: [],
                coins: []
            };

            document.querySelectorAll('.editor-tool').forEach(tool => {
                tool.addEventListener('click', () => {
                    document.querySelectorAll('.editor-tool').forEach(t =>
                        t.classList.remove('active'));
                    tool.classList.add('active');
                    editorState.tool = tool.dataset.tool;
                });
            });

            let isDrawing = false;
            let startX, startY;

            editorCanvas.addEventListener('mousedown', (e) => {
                const rect = editorCanvas.getBoundingClientRect();
                startX = snapToGrid(e.clientX - rect.left);
                startY = snapToGrid(e.clientY - rect.top);
                isDrawing = true;
            });

            editorCanvas.addEventListener('mouseup', (e) => {
                if (!isDrawing) return;
                isDrawing = false;

                const rect = editorCanvas.getBoundingClientRect();
                const endX = snapToGrid(e.clientX - rect.left);
                const endY = snapToGrid(e.clientY - rect.top);

                if (editorState.tool === 'erase') {
                    ['platforms', 'spikes', 'enemies', 'coins'].forEach(type => {
                        editorState[type] = editorState[type].filter(obj => {
                            return !checkCollision(
                                {x: startX, y: startY, width: 1, height: 1},
                                obj
                            );
                        });
                    });
                } else if (editorState.tool === 'platform') {
                    const width = Math.abs(endX - startX);
                    const height = Math.abs(endY - startY);
                    editorState.platforms.push({
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        width: Math.max(width, GRID_SIZE * 2),
                        height: Math.max(height, GRID_SIZE)
                    });
                } else if (editorState.tool === 'spike') {
                    editorState.spikes.push({
                        x: startX,
                        y: startY,
                        width: 30,
                        height: 20
                    });
                } else if (editorState.tool === 'enemy') {
                    editorState.enemies.push({
                        x: startX,
                        y: startY,
                        width: 25,
                        height: 25,
                        vx: 0,
                        vy: 0,
                        onGround: false
                    });
                } else if (editorState.tool === 'coin') {
                    editorState.coins.push({
                        x: startX,
                        y: startY,
                        width: 24,
                        height: 24,
                        collected: false
                    });
                }

                drawEditor();
            });

            drawEditor();
        }

        function drawEditor() {
            const editorCanvas = document.getElementById('editorCanvas');
            const editorCtx = editorCanvas.getContext('2d');

            // Draw grid
            editorCtx.fillStyle = game.bgColor;
            editorCtx.fillRect(0, 0, editorCanvas.width, editorCanvas.height);

            editorCtx.strokeStyle = 'rgba(0,0,0,0.1)';
            editorCtx.lineWidth = 1;
            for (let x = 0; x < editorCanvas.width; x += GRID_SIZE) {
                editorCtx.beginPath();
                editorCtx.moveTo(x, 0);
                editorCtx.lineTo(x, editorCanvas.height);
                editorCtx.stroke();
            }
            for (let y = 0; y < editorCanvas.height; y += GRID_SIZE) {
                editorCtx.beginPath();
                editorCtx.moveTo(0, y);
                editorCtx.lineTo(editorCanvas.width, y);
                editorCtx.stroke();
            }

            // Draw platforms
            editorCtx.fillStyle = '#2c3e50';
            editorState.platforms.forEach(p => {
                editorCtx.fillRect(p.x, p.y, p.width, p.height);
            });

            // Draw spikes
            editorCtx.fillStyle = '#e74c3c';
            editorState.spikes.forEach(spike => {
                editorCtx.beginPath();
                editorCtx.moveTo(spike.x, spike.y + spike.height);
                editorCtx.lineTo(spike.x + spike.width / 2, spike.y);
                editorCtx.lineTo(spike.x + spike.width, spike.y + spike.height);
                editorCtx.closePath();
                editorCtx.fill();
            });

            // Draw enemies
            editorCtx.fillStyle = '#e74c3c';
            editorState.enemies.forEach(enemy => {
                editorCtx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });

            // Draw coins
            editorCtx.fillStyle = '#f1c40f';
            editorState.coins.forEach(coin => {
                editorCtx.beginPath();
                editorCtx.arc(coin.x + coin.width/2, coin.y + coin.height/2,
                             coin.width/2, 0, Math.PI * 2);
                editorCtx.fill();
            });
        }

        function saveCustomLevel() {
            const levelData = {
                platforms: editorState.platforms,
                spikes: editorState.spikes,
                enemies: editorState.enemies,
                coins: editorState.coins
            };

            const code = btoa(JSON.stringify(levelData));
            document.getElementById('levelCodeOutput').value = code;
        }

        function testCustomLevel() {
            const code = document.getElementById('levelCodeOutput').value;
            if (!code) {
                alert('Please save the level first!');
                return;
            }

            try {
                const levelData = JSON.parse(atob(code));
                game.customLevel = levelData;
                currentLevelData = levelData;
                resetLevel();
                closeModal('editorModal');
            } catch (e) {
                alert('Error testing level!');
            }
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById('modalOverlay').style.display = 'none';
            if (game.started) {
                game.paused = false;
            }
        });

        // Initialize
        drawSkinPreviews();
        updateBodyBackground();
        updateUI();
        gameLoop();
    </script>
</body>
</html>
